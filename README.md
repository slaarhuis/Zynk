# Zynk Templafy Content Connector Service

## Overview

This Node.js application acts as a custom content connector service for Templafy. It allows users within Templafy to browse a list of predefined document/presentation templates managed by this service and trigger the generation of a personalized PDF document using the Templafy Document Generation API.

The service provides a simple web-based admin interface for managing the available templates and configuring service settings, including Templafy API credentials and connection details.

## Features

*   **Templafy Custom Content Connector:** Implements the required API endpoints (`/content` and `/content/{id}/download-url`) for integration with Templafy.
*   **OAuth 2.0 Client Credentials Flow:** Authenticates requests from Templafy using the standard client credentials grant type.
*   **Templafy Document Generation API Integration:** Calls the Templafy DocGen API to generate personalized PDFs based on selected templates.
*   **Admin Interface:** A web UI for:
    *   Managing document/presentation templates (adding, listing).
    *   Configuring service settings (Templafy API details, connector credentials).
    *   Managing admin users.
*   **Database Storage:** Uses Sequelize ORM to store template details, settings, and user credentials (supports PostgreSQL and SQLite).
*   **Test Email Workaround:** Includes an option to use a hardcoded email address for document generation, useful if Templafy doesn't send the required user context header.

## Prerequisites

*   **Node.js:** Version 18.x or later recommended.
*   **npm:** Included with Node.js.
*   **Database:**
    *   **PostgreSQL:** Recommended for production.
    *   **SQLite:** Suitable for development and testing (default).
*   **Templafy Tenant:** Access to a Templafy tenant with permissions to configure custom content connectors and access the Document Generation API.
*   **Templafy API Credentials:**
    *   A static Bearer Token for accessing the Templafy Document Generation API.
    *   Client ID and Client Secret for the connector itself (generated by this service, configured in Templafy).

## Installation

1.  **Clone the Repository (or Extract Files):**
    ```bash
    # If using Git
    git clone <repository_url>
    cd zynk-templafy-service

    # Or extract the provided zip file
    unzip zynk-templafy-service-vx.x.zip
    cd zynk-templafy-service
    ```

2.  **Install Dependencies:**
    ```bash
    npm install
    ```

3.  **Database Setup:**
    *   **Configuration:** Edit the `config/config.json` file to set up your database connection details (username, password, database name, host, dialect). The default is SQLite (`dialect: "sqlite"`, `storage: "data/dev.sqlite"`). For PostgreSQL, change the dialect and provide the necessary credentials.
    *   **Create Database:** If using PostgreSQL, ensure the specified database exists.
    *   **Run Migrations:** Apply the database schema.
        ```bash
        npx sequelize-cli db:migrate
        ```
    *   **(Optional) Seed Admin User:** The application attempts to create a default admin user (`admin`/`password`) on first run if no users exist. You may want to change this password immediately.

4.  **Environment Variables:**
    *   **Session Secret:** A secret key is required for session management. Set it in your environment. Generate a strong, random string for this.
        ```bash
        # Example (replace with a real secret)
        export SESSION_SECRET=\'your_very_strong_and_random_session_secret\'
        ```
    *   **(Optional) Port:** The service runs on port 3000 by default. You can change this via the `PORT` environment variable:
        ```bash
        export PORT=8080
        ```

## Configuration

Most configuration is done via the web admin interface after starting the service.

1.  **Start the Service:** (See "Running the Service" below)
2.  **Access Admin UI:** Open your web browser and navigate to `http://localhost:3000` (or your configured host/port).
3.  **Login:** Log in using the default credentials (`admin`/`password`) or the credentials you created.
4.  **Navigate to Service Configuration:** Click on "Service Configuration" in the admin dashboard.
5.  **Configure Settings:**
    *   **Connector Credentials:**
        *   `Client ID`: Generate a secure string (e.g., using the "Generate Credential" button) and enter it here. This ID must be configured in your Templafy connector settings.
        *   `Client Secret`: Generate a secure string (e.g., using the "Generate Credential" button) and enter it here. This secret must be configured in your Templafy connector settings.
        *   `Default Item Limit`: Max items per page for the content list.
        *   `Allow Search`: Enable/disable search functionality in Templafy.
    *   **Templafy API Configuration:**
        *   `Tenant ID`: Your Templafy tenant ID (e.g., `yourtenant`).
        *   `API Version`: The Templafy API version to use (e.g., `v3`).
        *   `Bearer Token`: The static Bearer token obtained from Templafy for accessing the Document Generation API.
    *   **Document Generation Workaround:**
        *   `Use Test Email for DocGen`: Check this box if Templafy is not sending the `x-TemplafyUser` header.
        *   `Test Email Address`: If the box is checked, enter the email address to use for all document generation requests.
6.  **Save Configuration:** Click "Save Settings".

7.  **Manage Templates:**
    *   Navigate to "Manage Templafy Items".
    *   Click "Add New Item".
    *   Fill in the details for each template you want to make available:
        *   `Item Name`: Display name in Templafy.
        *   `Description`: Optional description.
        *   `Space ID`: The Templafy Space ID where the template resides.
        *   `Asset ID`: The Templafy Asset ID of the template.
        *   `Document Type`: Select `document` or `presentation` based on the template type.
    *   Click "Save Item".

## Running the Service

```bash
# Make sure environment variables (like SESSION_SECRET) are set
node server.js
```
The service will start, typically listening on `http://localhost:3000`.

## Usage

1.  **Templafy Connector Setup:**
    *   In your Templafy tenant admin settings, create a new "Custom Content Connector".
    *   **Authentication:** Select "OAuth 2.0" -> "Client Credentials".
    *   **Client ID:** Enter the Client ID you generated and saved in the service configuration.
    *   **Client Secret:** Enter the Client Secret you generated and saved in the service configuration.
    *   **Token Endpoint URL:** Enter the full URL to the service's token endpoint (e.g., `https://your-service-domain.com/auth/oauth/token`).
    *   **Content Endpoint URL:** Enter the full URL to the service's content endpoint (e.g., `https://your-service-domain.com/content/`).
    *   Save the connector configuration in Templafy.

2.  **Accessing Content in Templafy:** Users in your Templafy tenant should now be able to access the connector and see the list of items configured in the service's admin interface.

3.  **Generating Documents:** When a user selects an item in Templafy, Templafy will call the service's `/content/{id}/download-url` endpoint. The service will then:
    *   Verify the request.
    *   Determine the user email (either from the `x-TemplafyUser` header or the configured test email).
    *   Call the Templafy Document Generation API.
    *   Return the PDF download URL provided by Templafy.
    *   Templafy will then present the download link to the user.

## Troubleshooting

*   **Check Server Logs:** The service logs detailed information to the console. Check the output of `node server.js` for errors related to database connections, authentication, API calls, etc.
*   **`Unknown authentication strategy "local"`:** Ensure the admin login route (`/auth/login`) uses the `local-admin` strategy.
*   **`TypeError: server._exchange is not a function`:** Check `oauth2Server.js` and `authRoutes.js` to ensure the `oauth2orize` server instance is exported and imported correctly.
*   **`SequelizeDatabaseError: column "id" of relation "AccessTokens" does not exist`:** The `AccessToken` model needs `primaryKey: true` set for the `token` field. You may need to undo and redo the migration (`20250502215935-create-access-token-table.js`) after fixing the model.
*   **404 Errors on `/content/`:** Verify the `Content Endpoint URL` in Templafy matches the route prefix used in `server.js` (should be `/content/`) and that the routes in `contentRoutes.js` are defined relative to that prefix (e.g., `/` and `/:contentId/download-url`).
*   **400/500 Errors on `/content/{id}/download-url`:**
    *   Check if the `x-TemplafyUser` header is being sent by Templafy (visible in server logs). If not, enable the "Use Test Email" workaround in the admin config.
    *   Verify the Templafy API Configuration (Tenant ID, API Version, Bearer Token) is correctly saved in the admin config.
    *   Ensure the Space ID, Asset ID, and Document Type are correct for the requested template item.
    *   Check the detailed error messages from the Templafy API in the server logs.

## License

This project is currently unlicensed. Feel free to adapt it to your needs.

